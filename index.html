<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™æ­¢ç”»ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
    <style>
        :root { --primary: #0070f3; --error: #d93025; --success: #28a745; --bg: #f8f9fa; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: #333; line-height: 1.6; padding: 20px; }
        .container { max-width: 700px; margin: 0 auto; background: white; padding: 40px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        h1 { text-align: center; font-size: 1.5rem; margin-bottom: 30px; }
        
        #drop-zone { border: 2px dashed #ddd; border-radius: 12px; padding: 60px 20px; text-align: center; cursor: pointer; transition: 0.2s; background: #fafafa; }
        #drop-zone:hover { border-color: var(--primary); background: #f0f7ff; }
        #drop-zone.disabled { opacity: 0.5; pointer-events: none; }
        
        #status { margin-top: 25px; text-align: center; font-weight: bold; min-height: 24px; font-size: 0.95rem; }
        .error-text { color: var(--error); padding: 10px; font-weight: bold; }
        
        #preview-area { display: none; margin-top: 30px; text-align: center; border-top: 1px solid #eee; padding-top: 30px; }
        video { max-width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: #000; }
        
        /* ãƒ„ã‚¤ãƒ¼ãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ */
        .tweet-config { margin-top: 20px; text-align: left; }
        .tweet-config label { font-size: 0.85rem; font-weight: bold; color: #666; }
        #tweet-text { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; margin-top: 5px; box-sizing: border-box; resize: vertical; }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; justify-content: center; flex-wrap: wrap; }
        .btn { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; text-decoration: none; font-size: 14px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .btn-dl { background: var(--success); color: white; flex: 1; min-width: 150px; }
        .btn-tw { background: #000; color: white; flex: 1; min-width: 150px; }
        .btn:hover { opacity: 0.8; transform: translateY(-1px); }
        
        .info { font-size: 0.8rem; color: #888; margin-top: 10px; }
        .step-note { font-size: 0.75rem; color: #666; margin-top: 15px; background: #eee; padding: 10px; border-radius: 6px; }
    </style>
</head>
<body>

<div class="container">
    <h1>é™æ­¢ç”»ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>
    <div id="drop-zone">
        <p>ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br><span style="font-size: 0.85rem; color: #999;">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</span></p>
        <input type="file" id="file-input" accept="image/*" style="display: none;">
    </div>
    
    <div id="status"></div>

    <div id="preview-area">
        <video id="output-video" controls loop playsinline></video>
        <div id="res-display" class="info"></div>

        <div class="tweet-config">
            <label for="tweet-text">ğ• æŠ•ç¨¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</label>
            <textarea id="tweet-text" rows="3">ç”»åƒã‚’å‹•ç”»ã«å¤‰æ›ã—ã¾ã—ãŸã€‚ #é™æ­¢ç”»ãƒ¡ãƒ¼ã‚«ãƒ¼</textarea>
        </div>

        <div class="btn-group">
            <a id="download-link" class="btn btn-dl">â‘  å‹•ç”»ã‚’ä¿å­˜</a>
            <button id="tweet-btn" class="btn btn-tw">â‘¡ ğ•ã§ã‚·ã‚§ã‚¢</button>
        </div>
        
        <div class="step-note">
            â€»ğ•ã®ä»•æ§˜ä¸Šã€å‹•ç”»ã¯è‡ªå‹•ã§æ·»ä»˜ã•ã‚Œã¾ã›ã‚“ã€‚<br>
            ã€Œä¿å­˜ã€ã—ãŸå¾Œã«ã€Œã‚·ã‚§ã‚¢ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã€æŠ•ç¨¿ç”»é¢ã§å‹•ç”»ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
        </div>

        <button onclick="location.reload()" style="margin-top:30px; background:none; border:none; color:#999; text-decoration:underline; cursor:pointer; font-size:0.8rem;">åˆ¥ã®ç”»åƒã‚’å¤‰æ›ã™ã‚‹</button>
    </div>
</div>

<script>
    const dropZone = document.getElementById('drop-zone');
    const status = document.getElementById('status');
    const fileInput = document.getElementById('file-input');
    const previewArea = document.getElementById('preview-area');
    const videoEl = document.getElementById('output-video');
    const tweetBtn = document.getElementById('tweet-btn');
    const tweetText = document.getElementById('tweet-text');

    dropZone.onclick = () => { if (!dropZone.classList.contains('disabled')) fileInput.click(); };
    fileInput.onchange = (e) => { if (e.target.files[0]) handleUpload(e.target.files[0]); };
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.borderColor = "var(--primary)"; };
    dropZone.ondragleave = () => { dropZone.style.borderColor = "#ddd"; };
    dropZone.ondrop = (e) => { 
        e.preventDefault(); 
        if (!dropZone.classList.contains('disabled') && e.dataTransfer.files[0]) {
            handleUpload(e.dataTransfer.files[0]); 
        }
    };

    async function handleUpload(file) {
        status.innerText = "å‹•ç”»ã‚’ç”Ÿæˆä¸­...";
        previewArea.style.display = "none";
        dropZone.classList.add('disabled');

        try {
            const isAI = await checkAI(file);
            if (isAI) {
                status.innerHTML = `<div class="error-text">AIç”Ÿæˆç”»åƒã®ç–‘ã„ãŒã‚ã‚‹ãŸã‚å‡¦ç†ã‚’ä¸­æ–­ã—ã¾ã—ãŸã€‚</div>`;
                dropZone.classList.remove('disabled');
                return;
            }

            const img = new Image();
            img.src = URL.createObjectURL(file);
            await new Promise(r => img.onload = r);

            const canvas = document.createElement('canvas');
            canvas.width = Math.floor(img.width / 2) * 2;
            canvas.height = Math.floor(img.height / 2) * 2;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            const stream = canvas.captureStream(30); 
            const recorder = new MediaRecorder(stream, {
                mimeType: MediaRecorder.isTypeSupported('video/mp4') ? 'video/mp4' : 'video/webm'
            });
            
            const chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: chunks[0].type });
                const url = URL.createObjectURL(blob);
                
                status.innerText = "ç”Ÿæˆå®Œäº†ï¼";
                videoEl.src = url;
                document.getElementById('res-display').innerText = `è§£åƒåº¦: ${canvas.width} x ${canvas.height}`;
                previewArea.style.display = "block";
                
                const dl = document.getElementById('download-link');
                dl.href = url;
                dl.download = `video_${Date.now()}.${blob.type.includes('mp4') ? 'mp4' : 'webm'}`;
                
                dropZone.classList.remove('disabled');
            };

            recorder.start();
            setTimeout(() => recorder.stop(), 3100);

        } catch (e) {
            console.error(e);
            dropZone.classList.remove('disabled');
            status.innerHTML = `<div class="error-text">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</div>`;
        }
    }

    tweetBtn.onclick = () => {
        const text = encodeURIComponent(tweetText.value);
        const url = `https://twitter.com/intent/tweet?text=${text}`;
        window.open(url, '_blank');
    };

    const SIGS = [
        "chatgpt", "dall-e", "openai", "google", "gemini", "deepmind", "imagen",
        "grok", "xai", "midjourney", "nijijourney", "stable diffusion", "automatic1111", 
        "comfyui", "novelai", "civitai", "sdxl", "adobe firefly", "bing image creator", 
        "microsoft designer", "generated by", "created with"
    ];

    async function checkAI(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const uint8 = new Uint8Array(e.target.result);
                    const decoder = new TextDecoder('utf-8', {fatal: false});
                    const t1 = decoder.decode(uint8).toLowerCase();
                    const t2 = new TextDecoder('utf-8').decode(uint8.filter(b => b !== 0)).toLowerCase();

                    for (const s of SIGS) {
                        if (t1.includes(s) || t2.includes(s)) {
                            resolve(true);
                            return;
                        }
                    }
                    resolve(false);
                } catch {
                    resolve(false);
                }
            };
            reader.readAsArrayBuffer(file);
        });
    }
</script>

</body>
</html>
