<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é™æ­¢ç”»ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
    <style>
        :root { 
            --primary: #0070f3; 
            --x-black: #000000;
            --success: #00ba7c;
            --bg: #f4f7f9;
            --card-bg: #ffffff;
            --text-main: #0f1419;
            --text-sub: #536471;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic ProN", "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); 
            color: var(--text-main); 
            margin: 0; padding: 0;
            display: flex; justify-content: center;
            min-height: 100vh;
        }

        .container { width: 100%; max-width: 500px; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; }
        .main-card { background: var(--card-bg); border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        h1 { font-size: 1.25rem; text-align: center; margin: 0 0 20px; font-weight: 800; }

        #drop-zone { border: 2px dashed #cfd9de; border-radius: 16px; padding: 50px 20px; text-align: center; cursor: pointer; background: #fafafa; transition: 0.2s; }
        #drop-zone:hover { border-color: var(--primary); background: #f0f7ff; }
        #drop-zone p { margin: 0; font-weight: bold; }
        #drop-zone span { font-size: 0.8rem; color: var(--text-sub); display: block; margin-top: 8px; }

        #status { margin: 15px 0; text-align: center; font-weight: bold; font-size: 0.9rem; min-height: 24px; color: var(--primary); }

        #preview-area { display: none; }
        video { width: 100%; border-radius: 12px; background: #000; margin-bottom: 20px; }

        .controls { display: flex; flex-direction: column; gap: 15px; }
        .input-label { font-size: 0.85rem; font-weight: bold; color: var(--text-sub); margin-bottom: 5px; display: block; }
        
        #tweet-text { width: 100%; padding: 12px; border: 1px solid #cfd9de; border-radius: 12px; font-family: inherit; font-size: 1rem; box-sizing: border-box; resize: none; }

        .btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 5px; }
        .btn { padding: 14px; border-radius: 12px; border: none; cursor: pointer; font-weight: 800; text-decoration: none; font-size: 1rem; text-align: center; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        
        .btn-dl { background: var(--success); color: white; }
        .btn-tw { background: var(--x-black); color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        .footer-info { margin-top: 30px; font-size: 0.75rem; color: var(--text-sub); line-height: 1.6; text-align: center; }
        .reset-link { display: block; margin: 20px auto 0; color: var(--text-sub); text-decoration: underline; font-size: 0.8rem; border: none; background: none; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="main-card">
        <h1>é™æ­¢ç”»ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>
        
        <div id="drop-zone">
            <p>ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
            <span>ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ­ãƒƒãƒ—</span>
            <input type="file" id="file-input" accept="image/*" style="display: none;">
        </div>
        
        <div id="status"></div>

        <div id="preview-area">
            <video id="output-video" controls loop playsinline muted></video>
            
            <div class="controls">
                <div>
                    <span class="input-label">ğ• æŠ•ç¨¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</span>
                    <textarea id="tweet-text" rows="2">ç”»åƒã‚’å‹•ç”»ã«å¤‰æ›ã—ã¾ã—ãŸã€‚ #é™æ­¢ç”»ãƒ¡ãƒ¼ã‚«ãƒ¼</textarea>
                </div>

                <div class="btn-group">
                    <a id="download-link" class="btn btn-dl">å‹•ç”»ã‚’ä¿å­˜ã™ã‚‹</a>
                    <button id="tweet-btn" class="btn btn-tw">ğ•ã§ã‚·ã‚§ã‚¢</button>
                </div>
            </div>
            
            <button onclick="location.reload()" class="reset-link">åˆ¥ã®ç”»åƒã‚’å¤‰æ›ã™ã‚‹</button>
        </div>
    </div>

    <div class="footer-info">
        <p>å¤‰æ›ã•ã‚ŒãŸå‹•ç”»ã®æ¨©åˆ©ã¯å…ƒã®ç”»åƒã®æ‰€æœ‰è€…ã«å¸°å±ã—ã¾ã™ã€‚</p>
        <p>ç”»åƒã‚„å‹•ç”»ã¯ã‚µãƒ¼ãƒãƒ¼ã«ä¸€åˆ‡ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚</p>
    </div>
</div>

<script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const status = document.getElementById('status');
    const previewArea = document.getElementById('preview-area');
    const videoEl = document.getElementById('output-video');
    const dlLink = document.getElementById('download-link');

    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => { if (e.target.files[0]) processImage(e.target.files[0]); };

    function fixWebmDuration(blob, duration) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const buffer = e.target.result;
                const view = new DataView(buffer);
                resolve(new Blob([buffer], { type: blob.type }));
            };
            reader.readAsArrayBuffer(blob);
        });
    }

    async function processImage(file) {
        const buffer = await file.arrayBuffer();
        const text = new TextDecoder().decode(new Uint8Array(buffer)).toLowerCase();
        const SIGS = [
        "chatgpt", "dall-e", "openai", "google", "gemini", "deepmind", "imagen",
        "grok", "xai", "midjourney", "nijijourney", "stable diffusion", "automatic1111", 
        "comfyui", "novelai", "civitai", "sdxl", "adobe firefly", "bing image creator", 
        "microsoft designer", "generated by", "created with"
    ];
        if (SIGS.some(s => text.includes(s))) {
            status.innerHTML = `<span style="color:#d93025">AIç”Ÿæˆç”»åƒã®ç–‘ã„ãŒã‚ã‚‹ãŸã‚åˆ©ç”¨ä¸å¯</span>`;
            return;
        }

        status.innerText = "å‹•ç”»ã‚’ç”Ÿæˆä¸­...";
        dropZone.style.display = "none";

        const img = new Image();
        img.src = URL.createObjectURL(file);
        await new Promise(r => img.onload = r);

        const canvas = document.createElement('canvas');
        canvas.width = Math.floor(img.width / 2) * 2;
        canvas.height = Math.floor(img.height / 2) * 2;
        const ctx = canvas.getContext('2d');

        let mimeType = 'video/mp4;codecs=avc1';
        if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = 'video/webm;codecs=h264';
        if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = 'video/webm';

        const stream = canvas.captureStream(30);
        const recorder = new MediaRecorder(stream, {
            mimeType: mimeType,
            videoBitsPerSecond: 3000000 
        });

        const chunks = [];
        recorder.ondataavailable = e => { if(e.data.size > 0) chunks.push(e.data); };

        let active = true;
        function draw() {
            if (!active) return;
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            requestAnimationFrame(draw);
        }
        draw();

        recorder.onstop = async () => {
            active = false;
            let finalBlob = new Blob(chunks, { type: mimeType });
            
            const url = URL.createObjectURL(finalBlob);
            
            videoEl.src = url;
            videoEl.onloadedmetadata = () => {
                if (videoEl.duration === Infinity) {
                    videoEl.currentTime = 1e101;
                    videoEl.ontimeupdate = () => {
                        videoEl.currentTime = 0;
                        videoEl.ontimeupdate = null;
                    };
                }
            };

            previewArea.style.display = "block";
            status.innerText = "å®Œäº†ï¼ä¿å­˜ã—ã¦æŠ•ç¨¿ã—ã¦ãã ã•ã„";

            dlLink.href = url;
            const ext = mimeType.includes('mp4') ? 'mp4' : 'webm';
            dlLink.download = `video_${Date.now()}.${ext}`;
        };

        recorder.start(100); 
        setTimeout(() => { if(recorder.state === "recording") recorder.stop(); }, 10000);
    }

    document.getElementById('tweet-btn').onclick = () => {
        const text = encodeURIComponent(document.getElementById('tweet-text').value);
        window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
    };

    dropZone.ondragover = (e) => { e.preventDefault(); };
    dropZone.ondrop = (e) => { e.preventDefault(); processImage(e.dataTransfer.files[0]); };
</script>

</body>
</html>
