<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é™æ­¢ç”»ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
    <script src="https://cdn.jsdelivr.net/npm/fix-webm-duration@1.0.5/fix-webm-duration.js"></script>
    <style>
        :root { --primary: #0070f3; --x-black: #000; --success: #00ba7c; --bg: #f4f7f9; --text-main: #0f1419; --text-sub: #536471; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 450px; }
        .main-card { background: #fff; border-radius: 20px; padding: 25px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); }
        h1 { font-size: 1.2rem; text-align: center; margin: 0 0 20px; font-weight: 800; }

        .setting-box { background: #f0f3f5; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        .setting-label { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: bold; margin-bottom: 8px; }
        input[type="range"] { width: 100%; cursor: pointer; }

        #drop-zone { border: 2px dashed #cfd9de; border-radius: 16px; padding: 50px 10px; text-align: center; cursor: pointer; background: #fafafa; transition: 0.2s; }
        #drop-zone:hover { border-color: var(--primary); }
        #drop-zone p { margin: 0; font-weight: bold; }
        #drop-zone span { font-size: 0.75rem; color: var(--text-sub); display: block; margin-top: 5px; }

        #status { margin: 15px 0; text-align: center; font-weight: bold; font-size: 0.9rem; min-height: 24px; color: var(--primary); }
        #preview-area { display: none; }
        video { width: 100%; border-radius: 12px; background: #000; margin-bottom: 20px; }

        .btn { width: 100%; padding: 15px; border-radius: 12px; border: none; cursor: pointer; font-weight: 800; font-size: 1rem; margin-bottom: 12px; display: block; text-align: center; text-decoration: none; box-sizing: border-box; transition: 0.2s; }
        .btn-dl { background: var(--success); color: white; }
        .btn-tw { background: var(--x-black); color: white; }
        .btn:active { transform: scale(0.98); }
        
        #tweet-text { width: 100%; padding: 12px; border: 1px solid #cfd9de; border-radius: 12px; font-family: inherit; font-size: 1rem; margin-bottom: 15px; box-sizing: border-box; resize: none; }
        .footer { font-size: 0.7rem; color: var(--text-sub); text-align: center; margin-top: 30px; line-height: 1.6; }
    </style>
</head>
<body>

<div class="container">
    <div class="main-card">
        <h1>é™æ­¢ç”»ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>

        <div id="setup-area">
            <div class="setting-box">
                <div class="setting-label"><span>å†ç”Ÿæ™‚é–“</span><span id="duration-val">5ç§’</span></div>
                <input type="range" id="duration-slider" min="3" max="10" value="5">
                <div style="font-size: 0.65rem; color: #666; margin-top: 5px;">â€»ğ•æŠ•ç¨¿ã§ã®ã‚¨ãƒ©ãƒ¼é˜²æ­¢ã®ãŸã‚5ç§’æ¨å¥¨</div>
            </div>
            <div id="drop-zone">
                <p>ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
                <span>ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ­ãƒƒãƒ—</span>
                <input type="file" id="file-input" accept="image/*" style="display: none;">
            </div>
        </div>
        
        <div id="status"></div>

        <div id="preview-area">
            <video id="output-video" controls loop playsinline muted></video>
            
            <div style="text-align: left; margin-bottom: 5px; font-size: 0.8rem; font-weight: bold; color: var(--text-sub);">ğ• æŠ•ç¨¿æœ¬æ–‡</div>
            <textarea id="tweet-text" rows="2">ç”»åƒã‚’å‹•ç”»ã«å¤‰æ›ã—ã¾ã—ãŸã€‚ #é™æ­¢ç”»ãƒ¡ãƒ¼ã‚«ãƒ¼</textarea>
            
            <a id="download-link" class="btn btn-dl">å‹•ç”»ã‚’ä¿å­˜ã™ã‚‹</a>
            <button id="tweet-btn" class="btn btn-tw">ğ•ã§ã‚·ã‚§ã‚¢</button>
            
            <button onclick="location.reload()" style="background:none; border:none; color:#999; text-decoration:underline; width:100%; font-size:0.8rem; cursor:pointer;">åˆ¥ã®ç”»åƒã‚’å¤‰æ›ã™ã‚‹</button>
        </div>
    </div>

    <div class="footer">
        å¤‰æ›ã•ã‚ŒãŸå‹•ç”»ã®æ¨©åˆ©ã¯å…ƒã®ç”»åƒã®æ‰€æœ‰è€…ã«å¸°å±ã—ã¾ã™ã€‚<br>
        ãƒ‡ãƒ¼ã‚¿ã¯ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ã•ã‚Œãšã€ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§å®Œçµã—ã¾ã™ã€‚
    </div>
</div>

<script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const status = document.getElementById('status');
    const previewArea = document.getElementById('preview-area');
    const setupArea = document.getElementById('setup-area');
    const videoEl = document.getElementById('output-video');
    const dlLink = document.getElementById('download-link');
    const durationSlider = document.getElementById('duration-slider');
    const durationVal = document.getElementById('duration-val');

    durationSlider.oninput = () => { durationVal.innerText = `${durationSlider.value}ç§’`; };
    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => { if (e.target.files[0]) processImage(e.target.files[0]); };

    async function processImage(file) {
    const SIGS = [
        "dall-e", "openai", "grok",
        "midjourney", "nijijourney",
        "stable diffusion", "automatic1111", "comfyui", "sdxl", "civitai", "dreamstudio",
        "novelai",
        "adobe firefly",
        "bing image creator", "microsoft designer",
        "google gemini", "google deepmind", "imagen"
    ];
        const buffer = await file.arrayBuffer();
        const text = new TextDecoder().decode(new Uint8Array(buffer)).toLowerCase();
        if (SIGS.some(s => text.includes(s))) {
            status.innerHTML = `<span style="color:#d32f2f">AIç”Ÿæˆç”»åƒã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚</span>`;
            return;
        }

        const sec = parseInt(durationSlider.value);
        status.innerText = "å‹•ç”»ã‚’ç”Ÿæˆä¸­...";
        setupArea.style.display = "none";

        const img = new Image();
        img.src = URL.createObjectURL(file);
        await new Promise(r => img.onload = r);

        const canvas = document.createElement('canvas');
        canvas.width = Math.floor(img.width / 2) * 2;
        canvas.height = Math.floor(img.height / 2) * 2;
        const ctx = canvas.getContext('2d');

        // éŒ²ç”»è¨­å®šï¼ˆğ•äº’æ›ï¼‰
        let mimeType = 'video/mp4;codecs=avc1';
        if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = 'video/webm;codecs=h264';
        if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = 'video/webm';

        const stream = canvas.captureStream(30);
        const recorder = new MediaRecorder(stream, { mimeType, videoBitsPerSecond: 3000000 });
        const chunks = [];
        recorder.ondataavailable = e => { if(e.data.size > 0) chunks.push(e.data); };

        const startTime = Date.now();

        let active = true;
        const draw = () => { if(active) { ctx.drawImage(img, 0, 0, canvas.width, canvas.height); requestAnimationFrame(draw); }};
        draw();

        recorder.onstop = async () => {
            active = false;
            const duration = Date.now() - startTime;
            let blob = new Blob(chunks, { type: mimeType });

            if (mimeType.includes('webm')) {
                blob = await ysFixWebmDuration(blob, duration);
            }

            const url = URL.createObjectURL(blob);
            videoEl.src = url;
            
            previewArea.style.display = "block";
            status.innerText = "ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ";

            dlLink.href = url;
            const ext = mimeType.includes('mp4') ? 'mp4' : 'webm';
            dlLink.download = `video_${Date.now()}.${ext}`;
        };

        recorder.start(100); 
        setTimeout(() => { if(recorder.state === "recording") recorder.stop(); }, sec * 1000);
    }

    document.getElementById('tweet-btn').onclick = () => {
        const text = encodeURIComponent(document.getElementById('tweet-text').value);
        window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
    };

    dropZone.ondragover = (e) => { e.preventDefault(); };
    dropZone.ondrop = (e) => { e.preventDefault(); processImage(e.dataTransfer.files[0]); };
</script>

</body>
</html>
