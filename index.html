<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™æ­¢ç”»ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        :root { --primary: #0070f3; --error: #ff4d4f; --success: #28a745; }
        body { font-family: -apple-system, "Segoe UI", Roboto, sans-serif; background: #f8f9fa; color: #333; line-height: 1.6; padding: 20px; }
        .container { max-width: 700px; margin: 0 auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h1 { text-align: center; font-size: 1.5rem; margin-bottom: 10px; }
        
        .policy-box { background: #f0f7ff; border: 1px solid #cce5ff; padding: 15px; border-radius: 8px; font-size: 0.85rem; margin-bottom: 20px; }
        .policy-box ul { margin: 5px 0 0; padding-left: 20px; }

        #drop-zone { border: 2px dashed #ccc; border-radius: 12px; padding: 40px 20px; text-align: center; cursor: pointer; transition: 0.2s; background: #fafafa; }
        #drop-zone:hover { border-color: var(--primary); background: #f0f7ff; }
        
        #status { margin-top: 20px; text-align: center; font-weight: bold; min-height: 24px; }
        .error-text { color: var(--error); background: #fff1f0; padding: 10px; border-radius: 5px; border: 1px solid var(--error); text-align: left; font-size: 0.9rem; }
        
        #preview-area { display: none; margin-top: 30px; text-align: center; border-top: 1px solid #eee; padding-top: 20px; }
        video { max-width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: #000; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 20px; justify-content: center; flex-wrap: wrap; }
        .btn { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; text-decoration: none; font-size: 14px; transition: 0.2s; }
        .btn-dl { background: var(--success); color: white; }
        .btn-tw { background: #000; color: white; }
        .btn:hover { opacity: 0.8; transform: translateY(-1px); }
        
        .info { font-size: 0.8rem; color: #666; margin-top: 10px; }
        
        #debug-log { margin-top:10px; font-size:0.75rem; color:#999; display:none; text-align:left; max-height:100px; overflow-y:auto; border:1px solid #eee; padding:5px;}
    </style>
</head>
<body>

<div class="container">
    <h1>é™æ­¢ç”»ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>

    <div class="policy-box">
        <strong>ã€å®‰å¿ƒãƒ»å®‰å…¨ã¸ã®å–ã‚Šçµ„ã¿ã€‘</strong>
        <ul>
            <li><strong>ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·:</strong> å‡¦ç†ã¯ã™ã¹ã¦ãŠå®¢æ§˜ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§è¡Œã‚ã‚Œã¾ã™ã€‚ç”»åƒã‚„å‹•ç”»ãŒã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ãƒ»ä¿å­˜ã•ã‚Œã‚‹ã“ã¨ã¯ä¸€åˆ‡ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
            <li><strong>æ¨©åˆ©ã®å¸°å±:</strong> æœ¬ãƒ„ãƒ¼ãƒ«ã§ç”Ÿæˆã•ã‚ŒãŸå‹•ç”»ã®æ¨©åˆ©ã¯ã€ã™ã¹ã¦åˆ©ç”¨è€…ã«å¸°å±ã—ã¾ã™ã€‚</li>
        </ul>
    </div>
    
    <div id="drop-zone">
        <p>ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br><span style="font-size: 0.8rem; color: #888;">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</span></p>
        <input type="file" id="file-input" accept="image/*" style="display: none;">
    </div>

    <div id="status"></div>
    <div id="debug-log"></div>

    <div id="preview-area">
        <h3 style="margin-bottom:10px;">ç”Ÿæˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
        <video id="output-video" controls loop playsinline></video>
        <div id="res-display" class="info"></div>
        <div class="btn-group">
            <a id="download-link" class="btn btn-dl">å‹•ç”»ã‚’ä¿å­˜ã™ã‚‹</a>
            <a id="tweet-link" class="btn btn-tw" target="_blank">ğ•(Twitter)ã§ã‚·ã‚§ã‚¢</a>
        </div>
        <button onclick="location.reload()" style="margin-top:20px; background:none; border:none; color:#666; text-decoration:underline; cursor:pointer;">åˆ¥ã®ç”»åƒã‚’å¤‰æ›</button>
    </div>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    let ffmpeg = null;

    const AI_SIGNATURES = [
        "chatgpt", "dall-e", "openai", 
        "google", "gemini", "deepmind", "imagen",
        "grok", "xai",
        "midjourney", "nijijourney", 
        "stable diffusion", "automatic1111", "comfyui", "novelai", "civitai", "sdxl",
        "adobe firefly", "bing image creator", "microsoft designer",
        "generated by", "created with"
    ];

    const fileInput = document.getElementById('file-input');
    const dropZone = document.getElementById('drop-zone');
    const status = document.getElementById('status');
    const previewArea = document.getElementById('preview-area');
    const videoEl = document.getElementById('output-video');
    const debugLog = document.getElementById('debug-log');

    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => handleUpload(e.target.files[0]);
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.borderColor = "var(--primary)"; };
    dropZone.ondragleave = () => { dropZone.style.borderColor = "#ccc"; };
    dropZone.ondrop = (e) => { e.preventDefault(); handleUpload(e.dataTransfer.files[0]); };

    async function handleUpload(file) {
        if (!file) return;
        status.innerHTML = "ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...";
        previewArea.style.display = "none";
        debugLog.style.display = "block";
        debugLog.innerText = "ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹...";

        try {
            const result = await checkAI(file);
            
            if (result.isAI) {
                status.innerHTML = `
                    <div class="error-text">
                        <strong>AIç”Ÿæˆç”»åƒã¨åˆ¤å®šã•ã‚Œã¾ã—ãŸ</strong><br>
                        æ¤œå‡ºãƒ¯ãƒ¼ãƒ‰: ã€Œ<b>${result.signature}</b>ã€<br>
                        <span style="font-size:0.8em; color:#666;">â€»ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ãƒ‡ãƒ¼ã‚¿ã«ç”ŸæˆAIã®åå‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚</span>
                    </div>`;
                debugLog.innerText += `\næ¤œå‡ºæˆåŠŸ: ${result.signature}`;
                return;
            } else {
                debugLog.innerText += `\nAIã‚·ã‚°ãƒãƒãƒ£ãªã—ã€‚å‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™ã€‚`;
            }
        } catch(e) {
            console.warn(e);
            debugLog.innerText += `\nè§£æã‚¨ãƒ©ãƒ¼(ç„¡è¦–ã—ã¦ç¶šè¡Œ): ${e.message}`;
        }

        try {
            await generateVideo(file);
        } catch (e) {
            console.error(e);
            status.innerHTML = `<div class="error-text">å‹•ç”»ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
        }
    }

    async function checkAI(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const buffer = e.target.result;
                    const uint8 = new Uint8Array(buffer);
                   
                    const decoder = new TextDecoder('utf-8', {fatal: false});
                    const textNormal = decoder.decode(uint8).toLowerCase();

                    const filteredArr = uint8.filter(b => b !== 0);
                    const textNoNulls = new TextDecoder('utf-8').decode(filteredArr).toLowerCase();

                    debugLog.innerText = "ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†ã€‚åˆ¤å®šä¸­...";

                    for (const sig of AI_SIGNATURES) {
                        if (textNormal.includes(sig)) {
                            resolve({ isAI: true, signature: sig });
                            return;
                        }
                        if (textNoNulls.includes(sig)) {
                            resolve({ isAI: true, signature: sig + " (WideChar)" });
                            return;
                        }
                    }
                    
                    resolve({ isAI: false });
                } catch (err) {
                    reject(err);
                }
            };
            
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
        });
    }

    async function generateVideo(file) {
        status.innerText = "å¤‰æ›ã‚¨ãƒ³ã‚¸ãƒ³èµ·å‹•ä¸­...";
        
        if (!ffmpeg) {
            ffmpeg = createFFmpeg({ 
                log: true,
                corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js'
            });
            await ffmpeg.load();
        }

        const img = new Image();
        img.src = URL.createObjectURL(file);
        await img.decode();
        const w = img.width;
        const h = img.height;

        status.innerText = `å‹•ç”»ç”Ÿæˆä¸­ï¼ˆ1ç§’ãƒ»${w}x${h}ï¼‰...`;
        
        const ext = file.name.split('.').pop();
        const inputName = `input.${ext}`;
        
        ffmpeg.FS('writeFile', inputName, await fetchFile(file));

        await ffmpeg.run(
            '-loop', '1',
            '-i', inputName,
            '-t', '1',                    
            '-c:v', 'libx264',
            '-crf', '18',                 
            '-pix_fmt', 'yuv420p',
            '-vf', 'scale=trunc(iw/2)*2:trunc(ih/2)*2', 
            'output.mp4'
        );

        const data = ffmpeg.FS('readFile', 'output.mp4');
        const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));

        status.innerText = "ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼";
        debugLog.style.display = 'none';
        videoEl.src = url;
        document.getElementById('res-display').innerText = `è§£åƒåº¦: ${w} x ${h} / é•·ã•: 1ç§’`;
        previewArea.style.display = "block";
        
        const dlLink = document.getElementById('download-link');
        dlLink.href = url;
        dlLink.download = `video_${Date.now()}.mp4`;

        const tweetLink = document.getElementById('tweet-link');
        const tweetText = encodeURIComponent("ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚"";
        tweetLink.href = `https://twitter.com/intent/tweet?text=${tweetText}`;
        
        try {
            ffmpeg.FS('unlink', inputName);
            ffmpeg.FS('unlink', 'output.mp4');
        } catch(e){}
    }
</script>

</body>
</html>
