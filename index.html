<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™æ­¢ç”»ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        :root { --primary: #0070f3; --error: #d93025; --success: #28a745; --bg: #f8f9fa; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: #333; line-height: 1.6; padding: 20px; }
        .container { max-width: 700px; margin: 0 auto; background: white; padding: 40px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        h1 { text-align: center; font-size: 1.5rem; margin-bottom: 30px; }
        
        #drop-zone { border: 2px dashed #ddd; border-radius: 12px; padding: 60px 20px; text-align: center; cursor: pointer; transition: 0.2s; background: #fafafa; }
        #drop-zone:hover { border-color: var(--primary); background: #f0f7ff; }
        #drop-zone.disabled { opacity: 0.5; pointer-events: none; }
        
        #status { margin-top: 25px; text-align: center; font-weight: bold; min-height: 24px; font-size: 0.95rem; }
        
        .error-text { color: var(--error); padding: 10px; font-weight: bold; }
        
        #preview-area { display: none; margin-top: 30px; text-align: center; border-top: 1px solid #eee; padding-top: 30px; }
        video { max-width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: #000; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 25px; justify-content: center; flex-wrap: wrap; }
        .btn { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; text-decoration: none; font-size: 14px; transition: 0.2s; }
        .btn-dl { background: var(--success); color: white; }
        .btn-tw { background: #000; color: white; }
        .btn:hover { opacity: 0.8; transform: translateY(-1px); }
        
        .info { font-size: 0.8rem; color: #888; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>é™æ­¢ç”»ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>
    
    <div id="drop-zone" class="disabled">
        <p>ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br><span style="font-size: 0.85rem; color: #999;">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</span></p>
        <input type="file" id="file-input" accept="image/*" style="display: none;">
    </div>

    <div id="status">ã‚·ã‚¹ãƒ†ãƒ æº–å‚™ä¸­...</div>

    <div id="preview-area">
        <video id="output-video" controls loop playsinline></video>
        <div id="res-display" class="info"></div>
        <div class="btn-group">
            <a id="download-link" class="btn btn-dl">ä¿å­˜ã™ã‚‹</a>
            <a id="tweet-link" class="btn btn-tw" target="_blank">ğ•ã§ã‚·ã‚§ã‚¢</a>
        </div>
        <button onclick="location.reload()" style="margin-top:20px; background:none; border:none; color:#999; text-decoration:underline; cursor:pointer; font-size:0.8rem;">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
    </div>
</div>

<script>
    let ffmpeg = null;
    let createFFmpeg, fetchFile;

    const dropZone = document.getElementById('drop-zone');
    const status = document.getElementById('status');
    const fileInput = document.getElementById('file-input');
    const previewArea = document.getElementById('preview-area');
    const videoEl = document.getElementById('output-video');

    window.onload = async () => {
        try {
            if (typeof FFmpeg === 'undefined') throw new Error();
            createFFmpeg = FFmpeg.createFFmpeg;
            fetchFile = FFmpeg.fetchFile;
            status.innerText = ""; 
            dropZone.classList.remove('disabled');
        } catch (e) {
            status.innerHTML = `<div class="error-text">ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</div>`;
        }
    };

    dropZone.onclick = () => { if (!dropZone.classList.contains('disabled')) fileInput.click(); };
    fileInput.onchange = (e) => { if (e.target.files[0]) handleUpload(e.target.files[0]); };
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.borderColor = "var(--primary)"; };
    dropZone.ondragleave = () => { dropZone.style.borderColor = "#ddd"; };
    dropZone.ondrop = (e) => { 
        e.preventDefault(); 
        if (!dropZone.classList.contains('disabled') && e.dataTransfer.files[0]) {
            handleUpload(e.dataTransfer.files[0]); 
        }
    };

    async function handleUpload(file) {
        status.innerText = "å‡¦ç†ä¸­...";
        previewArea.style.display = "none";

        try {
            const isAI = await checkAI(file);
            if (isAI) {
                status.innerHTML = `<div class="error-text">AIã®ç–‘ã„ã‚’æ¤œå‡ºã—ãŸãŸã‚ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã›ã‚“ã€‚</div>`;
                return;
            }
            await generateVideo(file);
        } catch (e) {
            status.innerHTML = `<div class="error-text">å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</div>`;
        }
    }

    const SIGS = [
        "chatgpt", "dall-e", "openai", "google", "gemini", "deepmind", "imagen",
        "grok", "xai", "midjourney", "nijijourney", "stable diffusion", "automatic1111", 
        "comfyui", "novelai", "civitai", "sdxl", "adobe firefly", "bing image creator", 
        "microsoft designer", "generated by", "created with"
    ];

    async function checkAI(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const uint8 = new Uint8Array(e.target.result);
                    const decoder = new TextDecoder('utf-8', {fatal: false});
                    const t1 = decoder.decode(uint8).toLowerCase();
                    const t2 = new TextDecoder('utf-8').decode(uint8.filter(b => b !== 0)).toLowerCase();

                    for (const s of SIGS) {
                        if (t1.includes(s) || t2.includes(s)) {
                            resolve(true);
                            return;
                        }
                    }
                    resolve(false);
                } catch {
                    resolve(false);
                }
            };
            reader.readAsArrayBuffer(file);
        });
    }

    async function generateVideo(file) {
        if (!ffmpeg) {
            ffmpeg = createFFmpeg({ 
                log: false,
                corePath: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js'
            });
            await ffmpeg.load();
        }

        const img = new Image();
        img.src = URL.createObjectURL(file);
        await img.decode();
        
        const ext = file.name.split('.').pop();
        const inputName = `input.${ext}`;
        ffmpeg.FS('writeFile', inputName, await fetchFile(file));

        await ffmpeg.run(
            '-loop', '1', '-i', inputName, '-t', '1',                    
            '-c:v', 'libx264', '-crf', '18', '-pix_fmt', 'yuv420p',
            '-vf', 'scale=trunc(iw/2)*2:trunc(ih/2)*2', 
            'output.mp4'
        );

        const data = ffmpeg.FS('readFile', 'output.mp4');
        const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));

        status.innerText = "å®Œäº†ã—ã¾ã—ãŸ";
        videoEl.src = url;
        document.getElementById('res-display').innerText = `${img.width} x ${img.height}`;
        previewArea.style.display = "block";
        
        const dl = document.getElementById('download-link');
        dl.href = url;
        dl.download = `video_${Date.now()}.mp4`;
        
        const txt = encodeURIComponent("ç”»åƒã‚’å‹•ç”»ã«å¤‰æ›ã—ã¾ã—ãŸã€‚");
        document.getElementById('tweet-link').href = `https://twitter.com/intent/tweet?text=${txt}`;
        
        try { ffmpeg.FS('unlink', inputName); ffmpeg.FS('unlink', 'output.mp4'); } catch(e){}
    }
</script>

</body>
</html>
