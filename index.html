<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <script src="coi-serviceworker.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™æ­¢ç”»ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.7/dist/umd/ffmpeg.min.js"></script>
    <script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>
    <style>
        :root { --p: #0070f3; --err: #ff4d4f; }
        body { font-family: sans-serif; background: #f4f4f9; padding: 20px; display: flex; justify-content: center; }
        .card { background: white; max-width: 600px; width: 100%; padding: 30px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
        .policy { background: #eef6ff; padding: 15px; border-radius: 8px; font-size: 0.8rem; margin-bottom: 20px; border: 1px solid #d0e7ff; }
        #drop-zone { border: 2px dashed #ccc; padding: 40px; text-align: center; border-radius: 10px; cursor: pointer; background: #fafafa; }
        #drop-zone:hover { border-color: var(--p); background: #f0f7ff; }
        #status { margin: 20px 0; text-align: center; font-weight: bold; font-size: 0.9rem; }
        #preview-area { display: none; text-align: center; margin-top: 20px; }
        video { width: 100%; border-radius: 8px; border: 1px solid #ddd; }
        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .btn { padding: 12px 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; text-decoration: none; color: white; }
        .btn-dl { background: #28a745; }
        .btn-tw { background: #000; }
        .error { color: var(--err); background: #fff1f0; padding: 10px; border: 1px solid var(--err); border-radius: 5px; }
    </style>
</head>
<body>

<div class="card">
    <h1 style="text-align:center; font-size:1.4rem;">é™æ­¢ç”»ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>
    
    <div class="policy">
        å‡¦ç†ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§å®Œçµã—ã¾ã™ã€‚ç”»åƒãŒã‚µãƒ¼ãƒãƒ¼ã«é€ã‚‰ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
        ç”Ÿæˆã•ã‚ŒãŸå‹•ç”»ã®æ¨©åˆ©ã¯åˆ©ç”¨è€…ã«å¸°å±ã—ã¾ã™ã€‚
    </div>

    <div id="drop-zone">
        ã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã€ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯
        <input type="file" id="file-input" accept="image/*" style="display:none">
    </div>

    <div id="status">ã‚·ã‚¹ãƒ†ãƒ æº–å‚™ä¸­...</div>

    <div id="preview-area">
        <video id="out-video" controls loop></video>
        <div class="btn-group">
            <a id="dl-link" class="btn btn-dl">å‹•ç”»ã‚’ä¿å­˜</a>
            <a id="tw-link" class="btn btn-tw" target="_blank">ğ•ã«æŠ•ç¨¿</a>
        </div>
        <button onclick="location.reload()" style="margin-top:20px; background:none; border:none; text-decoration:underline; cursor:pointer; color:#666;">åˆ¥ã®ç”»åƒã‚’é¸æŠ</button>
    </div>
</div>

<script>
    const { FFmpeg } = FFmpegWASM;
    const { fetchFile, toBlobURL } = FFmpegUtil;
    let ffmpeg = null;

    const AI_SIGS = ["stable diffusion", "midjourney", "dall-e", "novelai", "adobe firefly", "comfyui", "automatic1111"];

    const statusEl = document.getElementById('status');
    const input = document.getElementById('file-input');
    const dropZone = document.getElementById('drop-zone');

    async function initFFmpeg() {
        try {
            if (ffmpeg) return;
            ffmpeg = new FFmpeg();
            const baseURL = 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd';
            await ffmpeg.load({
                coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
                wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
            });
            statusEl.innerText = "âœ… æº–å‚™å®Œäº†ã€‚ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚";
        } catch (e) {
            console.error(e);
            statusEl.innerHTML = "<span class='error'>ã‚¨ãƒ³ã‚¸ãƒ³ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚GitHubã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</span>";
        }
    }

    window.addEventListener('load', initFFmpeg);

    dropZone.onclick = () => input.click();
    input.onchange = (e) => process(e.target.files[0]);
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.borderColor = "#0070f3"; };
    dropZone.ondrop = (e) => { e.preventDefault(); process(e.dataTransfer.files[0]); };

    async function process(file) {
        if (!file) return;
        if (!ffmpeg || !ffmpeg.loaded) {
            statusEl.innerText = "ã‚¨ãƒ©ãƒ¼ï¼šã‚¨ãƒ³ã‚¸ãƒ³ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
            return;
        }

        statusEl.innerText = "è§£æä¸­...";

        const blobText = await file.slice(0, 1024 * 512).text();
        if (AI_SIGS.some(s => blobText.toLowerCase().includes(s))) {
            statusEl.innerHTML = "<div class='error'>AIç”Ÿæˆã®ç–‘ã„ãŒã‚ã‚‹ãŸã‚ã€ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã›ã‚“ã€‚</div>";
            return;
        }

        try {
            statusEl.innerText = "1ç§’å‹•ç”»ã‚’ç”Ÿæˆä¸­ï¼ˆé«˜ç”»è³ªï¼‰...";
            
            const img = new Image();
            img.src = URL.createObjectURL(file);
            await img.decode();
            const w = img.width, h = img.height;

            await ffmpeg.writeFile('in', await fetchFile(file));
            await ffmpeg.exec([
                '-loop', '1', '-i', 'in', '-t', '1',
                '-c:v', 'libx264', '-crf', '18', '-pix_fmt', 'yuv420p',
                '-vf', 'scale=trunc(iw/2)*2:trunc(ih/2)*2',
                'out.mp4'
            ]);

            const data = await ffmpeg.readFile('out.mp4');
            const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));

            statusEl.innerText = "ç”Ÿæˆå®Œäº†ï¼";
            document.getElementById('out-video').src = url;
            document.getElementById('preview-area').style.display = "block";
            document.getElementById('dl-link').href = url;
            document.getElementById('dl-link').download = `video_${w}x${h}.mp4`;
            document.getElementById('tw-link').href = `https://twitter.com/intent/tweet?text=${encodeURIComponent("ç”»åƒã‚’å‹•ç”»ã«å¤‰æ›ã—ã¾ã—ãŸ")}`;

        } catch (err) {
            console.error(err);
            statusEl.innerText = "å¤‰æ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
        }
    }
</script>
</body>
</html>
